# 祝日取得処理実装 #55

- todo
  - [x] device infoの設定する
  - [x] Holidayとしてカレンダーをどのように保持するか
  - [x] sembast実装
  - [x] カレンダーのパーミッションフローをどうするか
  - [x] パーミッションダイアログを複数回表示することできるのか
  - [x] permission handler調査
  - [x] 祝日画面の状態整理
  - [x] permission状態変わったらカレンダーを取得するようにする
  - [x] カレンダーを選べるようにする
  - [x] カレンダーを取得する
  - [x] 設定画面から戻ってきた時にパーミッションを再度取得する処理
  - [x] sheetにしてみる
  - [x] 設定画面に項目を追加する
  - [x] 許可リクエスト画面作成
  - [x] 色変換方法
  - [x] driibleで選択かくにん
  - [x] nameでduplicate排除する
  - [x] アルファベット順にsortする
  - [x] checkboxいいやつ探す
  - [x] aaaの名前考える
  - [x] 背景色どうするか考える
  - [x] 選んだやつは上に表示するようにする リファクタリング
  - [x] 真っ黒をやめてみる
  - [x] カレンダーempty画面
  - [x] カレンダーempty画面がチラつく問題
  - [x] Holiday取得時カクカクになる問題
  - [x] calendarViewにHoliday取得処理実装する
  - [x] daterangeを指定するようにする
  - [x] エラー処理
  - [x] permission handlerのios対応処理をかく
  - [x] 命名を再考する　HolidayDeviceCalendarなど
  - [x] リファクタリングする
  - [x] 動作確認

## 動作確認

- パーミッション与えられていない時
  - [x] パーミッションダイアログは表示されるか
  - [x] パーミッションを断り、もう一度ボタンを押下した時に設定画面に遷移するか
  - [x] パーミションを与えてから、設定画面にオフにし、アプリ戻ってきた時、リクエスト画面が表示されるか
- パーミッションが与えられている時
  - [x] カレンダーをリストで表示するか
  - [x] 選択したカレンダーのイベントをメイン画面で表示してるか

## 命名を再考する　HolidayDeviceCalendarなど

- HolidayDeviceCalendarID
  - シンプルにDevicealendarIdでいい気がしてきた
    - メリット
      - これをDeviceCalendarにも適用することで、StringとHolidayDeviceCalendarIdの変換をしなくて済む
    - デメリット
      - 祝日として使われることがメソッドの名前でしかわからない
    - 結論
      - クラスから祝日を表してるのがいいので、HolidayDeviceCalendarIdがいいかな
        - 制約がメソッドの命名だけはきつい
  - DeviceCalendarIdにして、holidayはHolidayDeviceCalendarList()でidのリストを持つようにする
    - メリット
      - StringとHolidayDeviceCalendarの変換をしなくて済む
      - クラスで制約することができる
    - デメリット

## エラー処理

- エラーはメソッドの返り値にして、呼ぶ側でハンドルした方がいいと最近思っていた
  - それが直感的な感じがするし
- ただしこれだと、ViewModel内でしか呼ばないメソッドのエラーハンドルをすることができない
  - View側にエラーを伝える方法がないため
- そのため、エラーが起きた際はViewModelから通知する仕組みが必要そう
  - 妥当だと思う
  - ただ、それらをどの粒度で伝えるか
    - View側ですることを具体的に記載にするのか
    - 単純にエラーだけ通知するのか
  - 考えること
    - エラーの表示の方法は、Viewの関心ごとかな
      - ViewModelは状態の維持飲みに注力するのみで、その状態がどのように表示されているかは関心を持たない方がいい
      - 他のデータでもどのように表示するかについてはViewModelで扱っていない
      - ViewModelの関心ごとは、エラーのイベントを通知すること
  - 結論
    - 単純にエラーが起きたことだけを通知する
      - ViewModelの状態の変更による表示の方法はView側の責務
        - ViewModelは状態だけを保持すればいい
        - したがって、エラーが起きたことだけを通知する
      - 逆にViewModelでView側で何をするか具体的に書いてしまうと、他の状態のとの文脈に差が出てしまう気がする

## Holiday取得時カクカクになる問題

- カレンダーの読み出しがUIスレッドで行われている
  - 問題になってるのは、androidだけ
  - 以下ですでにissueが立ってる
    - <https://github.com/builttoroam/device_calendar/issues/181>
    - developにはマージされている
    - 対応自体はそんな大したことはない
    - 3.2.0.devにも含まれている？
      - 使ったところエラーが出る
      - Aval¥ivatyクラスに変換しないといけない場所でStringを直でつこっている
- 解決方法
  - 1 ~~対応されるまで待つ~~
    - 時間かかりそうだし、自分でできそうなのでなし
  - 2 commitを下に自分でバックグランドにする
  - 3 現在のバージョンに対応されたコミットだけをくっつけものを使用する
    - 特定のコミットだけ持ってくる作業ってできるのかな？
      - 厳しそう
      - 互いのコミットが関係しているため、特定のやつだけ持ってきても、変なことになりそう
      - 持ってきて、マージみたいな扱いにすればいいのか
      - でもcommitが別れすぎていてめんどくさいな
  - 4 ~~3.2.0.devのバグの部分を取り除く~~
    - どのバージョンを使用してるのかよくわからんのでなし
      - tagには存在しない
      - brachにもそれらしいものは存在しない
- 結論
  - 2にする
    - UIスレッドでカクツクのはUXを大きく損なうので、必ず対応したい
    - すでに対応済みのcommitがdevelopに組み込まれているるが、以下のことから自分で対応することにする
      - 他のcommitの影響がるかもしれない
      - 複数のコミットに別れすぎていてchery pickするのしんどい
      - 変更範囲は少ない

## カレンダーempty画面

- 端末に登録されているカレンダーが存在しません
- 端末にカレンダーを登録するには
  - iphone
    - 日本語
      - <https://support.apple.com/ja-jp/guide/iphone/iph3d1110d4/ios#:~:text=%E3%82%92%E7%85%A7%E4%BC%9A%E3%81%99%E3%82%8B-,%E3%80%8C%E8%A8%AD%E5%AE%9A%E3%80%8D%20%EF%BC%9E%E3%80%8C%E3%82%AB%E3%83%AC%E3%83%B3%E3%83%80%E3%83%BC%E3%80%8D%EF%BC%9E%E3%80%8C%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%80%8D%EF%BC%9E,%E6%83%85%E5%A0%B1%E3%82%92%E5%85%A5%E5%8A%9B%E3%81%97%E3%81%BE%E3%81%99%E3%80%82>
    - 英語
      - <https://support.apple.com/guide/iphone/use-multiple-calendars-iph3d1110d4/14.0/ios/14.0>
- android
  - Googleカレンダーに祝日を登録する方法
    - 英語
      - <https://support.google.com/calendar/answer/6084659?co=GENIE.Platform%3DAndroid&hl=en&oco=0#zippy=%2C%E5%9B%BD%E6%B0%91%E3%81%AE%E7%A5%9D%E6%97%A5%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%BE%E3%81%9F%E3%81%AF%E5%A4%89%E6%9B%B4%E3%81%99%E3%82%8B%2Cadd-or-change-country-holidays>
    - 日本語
      - <https://support.google.com/calendar/answer/6084659?co=GENIE.Platform%3DAndroid&hl=ja&oco=0#zippy=%2C%E5%9B%BD%E6%B0%91%E3%81%AE%E7%A5%9D%E6%97%A5%E3%82%92%E8%BF%BD%E5%8A%A0%E3%81%BE%E3%81%9F%E3%81%AF%E5%A4%89%E6%9B%B4%E3%81%99%E3%82%8B>

## 選んだやつは上に表示するようにする リファクタリング

- 選んだものを下に積み重ねるようにするか
  - 通常祝日のカレンダー一つしか選ばないと思うので、いいかな
    - 下に来た方が直感的でわかりやすが、それに対する実装は大変そう
      - Rx.combineで同期させるのではなく、Itemとして独立させないといけない
      - 更新処理とか大変そう
    - これは労力に見合う利益が得られない
      - 労力　実装
      - 利益
        - 下に積み重なって緒間的
          - 今回は複数選ぶようなものではないので、ここが直感的かどうかは、あまり影響しない
          - ユーザは一回しかここを設定しないといと思う

## calendarViewにHoliday取得処理実装する

- 表示処理がカクツク
  - 原因を探る
  - Android側でデバイスカレンダーのDBいじる際に、メインスレッドで行ってる説

## カレンダー選択画面作成

- 祝日のカレンダーを選択してください
- 選択したカレンダーは、日付の色が赤くなります

## 許可リクエスト画面作成

- [x] ermineでどのように表示してるか確認する
- ボタン
  - needDialog
    - 権限を許可数する
  - needSetting
    - 設定を開く
- メッセージ
  - 1 祝日を表示するには、カレンダー権限が必要です
- イラスト
  - 猫

## sheetにしてみる

- sheetパッケージ
  - 主要なのはこれしかなさそう
  - 昨日も十分あるので使うとしたらこれにあんるかな
    - <https://pub.dev/packages/modal_bottom_sheet>
- [x] exampleみる
- [x] scafflodでlayout infiniteのエラーが出る

## 設定画面から戻ってきた時にパーミッションを再度取得する処理

- 方法
  - 1 AppLifecycleStateで画面戻るタイミングを取得する
- 結論
  - 1にする
    - 他に思いつかない
    - 1で妥当な感じがする

## 祝日画面の状態整理

- granted
  - カレンダーが存在しない場合
    - カレンダーが存在しないために、祝日を表示することがでいないことを伝える
  - カレンダーが存在する場合
    - カレンダー一覧表示
    - 祝日選択されてるものは、チェックしておく
- needSetting
  - 画面真ん中にボタンを表示
    - そこから設定画面に遷移して、設定してもらう
- needDialog
  - 画面表示タイミングでダイアログを表示
  - ダイアログの結果次第で、grantedかneedSettingに遷移
- 考えること
  - 状態管理方法
    - 1 androidとiosでneedSettingが必要な状態が異なるので、これようにPermissionStatusをそのまま使用するよりも、これように状態定義する
      - android
        - needSetting: permanentlyDenied
      - ios
        - needSetting: denied
    - 2 androidの挙動をiosに揃える
      - deniedでダイアログは表示することはできるが、設定画面に遷移するようにする
    - 3 画面の状態をgrantedとそれ以外で管理する
      - grantedだったら、
        - カレンダーを表示する
      - grantedではないなら
        - 画面中央にボタンを表示して、それが押下されたらosごとにパーミッション取得処理を行う
        - 祝日を表示するためには、パーミッションが必要であることをメッセージで伝える
  - 結論
    - 3のアプローチがよさあそう
      - 状態ごとに必ず画面を表示することができる
      - 1のCalendarPermissionStatusを使うとより丁寧になるがどうするか
        - パッケージの変更の影響を受けないようにラップしておくか

## permission handler調査

- requestしてもgrantedの場合ダイアログは表示されない
- android
  - undetermined
    - まだダイアログを表示しない状態
  - granted
    - 許可が与えられてる
  - denied
    - 許可していない
    - ダイアログで拒否をしてもずっとこの状態
    - この状態でrequestとすると、ダイアログが表示される
    - 設定画面からパーミッションオフにするとこの状態になる
  - permanentlyDenied
    - 以降表示しないを選択するとこの状態になる
    - requestしてもダイアログは表示されない
    - 設定画面からパーミッションをいじることでgrantedかdeniedに遷移できる
  - restricted, limited
    - 関係ない
  - `フロー`
    - undetermined, denied
      - ダイアログ表示 `neeedDialog`
    - granted
      - 何もしない `granted`
    - permanentlyDenied
      - 設定画面に行っていじってもらう `needSetting`
        - これでgrantedかdeniedに遷移する
    - restricted
      - 無視 or dialog表示？
- ios
  - undetermined
    - まだダイアログを表示しない状態
  - granted
    - 許可が与えられてる
  - denied
    - 許可していない
    - ダイアログで拒否するとこうなる
    - この状態でrequestしてもダイアログが表示されない
  - limited
    - 制限がかけられる
    - カレンダーは関係なさそう
  - restricted
    - OSがアクセスを拒否してる
    - ユーザも設定を変えることができない
    - カレンダーは関係なさそう
  - permanentlyDenied
    - 関係ない
  - `フロー`
    - undetermined
      - ダイアログを表示 `needDialog`
    - denied
      - 設定画面に遷移 `needSetting`
    - granted
      - 何もしない `granted`
    - limited, restricted, permanentlyDenied
      - 無視 or dailog表示？
- 結論
  - osごとに処理を変えないといけない
    - 処理は上記の`フロー`部分を参照
    - 以下の条件分岐が存在する
      - needDialog
      - needSetting
      - granted

## パーミッションダイアログを複数回表示することできるのか

- 一回拒否された後はどのような挙動になるのだろうか
  - ios
    - 表示されなくなる
    - これだと、
      - 一回断られてから、パーミッションやっぱり許可するときに再度ダイアログを表示することができない
      - つまり、一回断られたかどうかを判別する必要がある
        - 断られていない パーミッション持っていない
          - ダイアログを表示
        - 断られた、パーミッション持っていない
          - 設定画面に遷移
  - android
    - 表示され続ける
    - 今後表示しないにチェック入れると、表示されなくなる
- 結論
  - permissionは別のライブラリを使用しよう
  - iosのでfalseの時、以下で分岐しないといけない
    - 初回起動でfalseの時、ダイアログ表示
    - 一回拒否されてflaseの時、設定画面遷移
  - しかし、true, falseなど上記を判別することができないため、他のパッケージを使用することにする

## カレンダーのパーミッションフローをどうするか

- カレンダー画面表示時
  - パーミッションが存在する
    - 祝日を表示する
  - 存在しない
    - 何もしない
- 祝日画面表示時
  - パーミッション存在する
    - デバイスカレンダーとHolidayDeviceCalendarを取得して画面表示
  - パーミッション存在しない
    - パーミッション許可ダイアログを表示する
      - 許可された場合
        - パーミッション存在するへ
      - 許可されない場合
        - 許可お願い画面を表示
        - 許可ダイアログを表示するボタンを配置すること

## sembast実装

- 命名どうするか
  - HolidayCalendar
    - IDだけでなく他の要素も保存できるように
    - Deviceカレンダーが絡んでいることがわかりづらい
    - これに祝日の情報があると思ってしまう
  - HolidayCalendarId
  - DeviceCalendarId
    - 祝日のために使うことが抜け落ちているので微妙
  - DeviceCalendarForHoliday
  - DeviceCalendarAsHoliday
  - HolidayDeviceCalendar
- 結論
  - HolidayDeviceCalendar
    - デバイスカレンダーであることも、祝日であることも示すことができている
    - 命名が素直
      - asとかがクラス名に入るとややこしい

## モデリングする

- HolidayDeviceCalendar
  - id
  - 説明
    - 祝日のカレンダーとして使うデバイスのカレンダー
    - このカレンダーに属してるイベントを祝日として扱う
    - 中身はDeviceCalendarから取得する
- DeviceCalendar
  - id
  - name
  - etc
  - 説明
    - デバイスのカレンダー
- Holiday
  - name
  - DateRange
  - DeviceCalendar

## Holidayとしてカレンダーをどのように保持するか

- 1 preference
  - List<String>を保存することはできるが、
  - 保存するデータが増えた場合にめんどくさい
- 2 sembast
  - 大袈裟感がある
  - だけど拡張性がある
    - id以外のデータを持つことができる
- 結論
  - sembastにする
    - 拡張性がある方が好き

## カレンダーのパーミッションフローをどうするか

- 方法
  - 1 サービスでパーミッション請求もする
    - サービスからダイアログを表示する処理することになるので、嫌だ
  - 2 View側でパーミッションの状態を取得して
    - 許可があれば、祝日表示
    - 許可がなければ、表示しない
    - androidみたいに許可がないと、メソッドを呼べないようにはできないポイ
      - @RequiresPermission()

## device infoの設定する

- [x] 多言語対応する
  - info.plistの方にも記述が必要なのか
    - 以下によると必要そう
      - <https://qiita.com/hikarut/items/825f0de352a254327d5e>
    - 特に対応が大変なわけではないので、英語のメッセージをぶち込んでおこう
- [x] メッセージを考える
  - 1 祝日を表示するために、カレンダーにアクセスします
    - 現在の用途はこれだな
    - 今後違うカレンダーが必要になれば、メッセージを変える必要がある
  - 2 デバイスのカレンダーを表示するために許可が必要です
　- 3 カレンダーを表示するために必要です
- 結論
  - 1にする
    - 今のとろこデバイスのカレンダーは祝日を表示するためにしか使用しないので、
    - 今後複数のデバイスのカレンダーを表示する時は、メッセージを変える必要がある
