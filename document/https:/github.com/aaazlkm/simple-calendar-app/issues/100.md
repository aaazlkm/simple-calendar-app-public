# 月が正しく表示されない #100

- todo
  - [x] 現象をまとめる
  - [x] カレンダーの月が重複して表示される
  - [x] onFloatingActionButtonTapボタンで_viewModel.yearMonthValueを渡してる
  - [x] たまに落ちる
  - [x] イベントリスト画面から+を押すと前日に対応してるように見える
  - [x] カレンダー画面から+を押すと前日に対応してるように見える？
  - [x] 日付pickerのcontrollerの値も変更すること
  - [x] TimeZoneがUTCの時、エラーになる
  - [x] timezoneが異なるとカレンダーの表示がおかしくなる
  - [x] timezoneが予定をDatePickerで変更すると一つずれる
  - [x] TZDateTime.from(dateTime, local)とTZDateTime()違い
  - [x] EventDate修正するかどうか
  - [x] イギリスで登録した後、日本で登録するとイベントの表示順がおかしいことになる
  - [x] 23:59にtimeを押下すると次の日に移行する
  - [x] 動作確認

## 23:59にtimeを押下すると次の日に移行する

- time picker押下の時の処理がうまくなかった
  - 当日の予定の場合、一時間プラスした方がわかりやすい
  - 当日以外の予定の場合、日時は対して関係ない
    - この時にtime pickerを押下するたびに次の日付に遷移するとわかりづらくなる
      - 23:30移行に当日以外のイベントをTime月で登録しようとすると自動で次の日になってしまう
    - これは挙動がよくわからんので、よくない
- 結論
  - 次の日に行かないようにする
    - % 24する

## 動作確認

- [x] fabの動作
- [x] /30の時にカレンダーが正しく表示されるか
- [x] 一日を4時間に区切りそれぞれでイベントの登録をして問題がないか確認する
- [x] イギリスで登録したイベントが日本で正しく表示されるか確認する
- [x] 異なるtimezoneで登録した時に、pickerの値が正しく表示されるか

## EventDate修正するかどうか

- ここで受け取りたい情報は、TimeZoneを考慮する必要のない日時の情報
  - 日本で13:00ならば、イギリスでも13:00として扱いたい
  - 2021/7/2を渡したのに2021/7/1として解釈されることは避けたい
  - 7/2を受け取ったのなら、7/2のまま処理をしたい
- > なのでTZDateTime()で生成する必要があるな

## TZDateTime.from(dateTime, local)とTZDateTime()違い

- localがイギリスで日本で7/2 00:00に登録した場合
  - TZDateTime.from(dateTime, local)では
    - 7/1 15:00 と解釈されて日付がずれる
    - fromではlocationによってTimeZoneの調整処理が実行されるため
  - TZDateTime()では
    - 7/2 00:00と解釈できる
- 上記が問題で、予定が一日ずれてしまう人がいたのかもしれないな
  - DateTimeのオフセットと、TzDateTimeのlocalが異なるときにアリエル気がする
    - そんなことがあるのかは知らんけど

## timezoneが予定をDatePickerで変更すると一つずれる

- 原因
  - 1 LocalTimeZoneとイベントのTimeZoneが異なるとずれてしまう
    - DatePickerで選んだ値は本来時刻の情報はいらないはずなのに、それらがTimeZoneの影響を受けてしまって、ずれてしまっている
      - イギリスの予定を日本で変更する場合、
        - DatePcikerで7/2 00:00の日付を選択しても、TimeZoneの関係で7/1 15:00と解釈されてしまう
          - > TZDateTimeは考えて使わないといけないな、時刻の情報を含んでしまう
- 解決策
  - 1 DatePickerで選択した値は、日付の情報だけを渡すようにする
    - いけた

## timezoneが異なるとカレンダーの表示がおかしくなる

- 原因
  - 1 カレンダーのフィルターの部分がうまくいっていない感じがする
    - イベントリストでは正しく表示されているっぽい
    - Databaseでは7/1で登録してるのに、カレンダーで表示する際にDateTimeLocalで表示してるために7/1 -> 6/30 15:00になってしまう
    - カレンダーでずらしてるのに、イベントリストではlocalに変換する表示がされていないので表示に矛盾を感じるんだな
    - どのような挙動が正しい挙動なのか？
      - ユーザが登録した日付通りに表示されるのが正しい挙動
        - timezoneが替わろうとどうだろうと、7/1に登録したものは7/1に表示されて欲しい
          - これは日付選択画面でtimezoneを選択できるならば話は別
- 想定するパターン
  - 登録した時のtimezoneと表示する時のTimezoneが同じ場合
    - この時は、登録した日付通りにカレンダーでもイベントリストでも表示して欲しい
      - 7/1に登録したら、7/1に表示して欲しい
  - 登録した時のtimezoneと表示する時のTimezoneが異なる場合
    - イギリスで7/1で登録したものを、日本で確認する場合どのように表示した方がいいのか？
      - 1 時差を考慮して、7/1 9:00と表示する
        - 現在の実装ではtimezoneの編集を行えないので、これで表示してしまうと単に時間がずれる印象を受ける気がする
      - 2 時差を考慮しないで、7/1 と表示する
        - イギリスで7/1 0:00開催なのに、日本で見ても7/1 00:00開催になってしまう (本来は7/1 09:00と表示するべき)
          - ただこれはTimeZoneを表示しないと、理解できない内容。
          - 表示していない場合単に時間がずれる印象になる
      - 結論
        - 2にする
          - 現在TimeZoneの表示をしていないため
          - 複数のTimeZoneにまたがって生活する人はそんなにいない気がするため
          - イギリスで7/100:00で登録したものを、日本で確認する場合イギリスで0:00だから日本では9:00か！とユーザ自身で気付けるので問題ない
            - 逆に自動で変換される方が、なんで時間が変わったのだろうと違和感を覚える感じがする？
          - これによりTimeZoneが異なっていても、表示される時間が同じになるはずである

## TimeZoneがUTCの時、エラーになる

- databseに登録されていないっポイ
- やること
  - databseに登録されているlocationの一覧を取得する
    - 他にどんなものが対応していないのか確認したい
      - 数が多すぎて確認するのは難しそう
  - databaseに存在しない場合の対策方法
    - 1 存在しない場合は、UTCを設定する
    - 2 存在しない場合を全て把握して、それぞれについて対策をする
      - さすがに果てしない感じがする
  - 結論
    - 存在しない場合はUTCを設定するようにする

## 現象をまとめる

- 1 カレンダーの月が重複して表示される
- 2 イベントリスト画面から+を押すと前日に対応してるように見える
- 3 カレンダー画面から+を押すと前日に対応してるように見える？

## カレンダー画面から+を押すと前日に対応してるように見える？

- 原因
  - 1 _viewModel.yearMonthValueを渡してしまってる
    - 1 カレンダーの月が重複して表示されると同様の問題があるため、5/31に2月の画面で+を押下すると、3/3が帰ってくる
      - これが怒るにしても、レビューで報告されてような現象は起きない気がする
        - 4/26にレビューしており、この日付では上記の問題は発生しない
    - 2 前の日付というのは、前の月のことを言ってるのか？
      - 現在の日付が4/26で、３月の画面から+を押下した場合、日付は3/26になる
        - この時、ユーザは4/26を期待しているのに、3/26になるために前の日付が対応してるように感じる？
          - さすがに違う気がする
    - 3 これも違う気がするな
      - +を押下すると前日に対応するということから、ユーザは明確にこの日付に登録したいという考えを持ってる
        - しかし、カレンダー画面で＋を押下する時に、この日付に登録したい！という考えを持たない気がする
        - なので、カレンダー画面ではなくイベントリスト画面が原因な気がする
- 解決策
- 結論
  - カレンダー画面ではない気がする
    - レビューの書き方からそのように感じる
  - イベントリスト画面の問題なのか？
  - それか1を修正中に直ったかもしれない

## イベントリスト画面から+を押すと前日に対応してるように見える

- 原因  
  - 1 イベントリスト画面に遷移する段階で日付が前日を挿してしまってる
    - ここはずれなさそう
      - CalendarViewのセルのDateをそのまま渡してるため
  - 2 pagerの日付の更新がうまくいっていないか
    - ログでみた感じpageIndexの通知はうまくいってるように見える
    - 日付の計算もうまくいってそう
      - ということは、onDayChangedに渡される日付も正しいことになり、edit画面に遷移する際の日付の正しいことになる
  - 3 ~~問題になっているのがここではないのではないか~~
    - これな気がする
      - 特定の日にイベントを追加したい場合は、+ボタンを押すと前日に対応しているように見えて、とても迷惑で残念です。
      - 上記のように言ってるので、イベントリストの+ではなく、ホームの+なのかもしれない
    - ホームの方かと思ったが、言い方的にイベントリスト画面な気がする
      - 理由はホームの調査のところに記載
  - 4 異なるtimezoneで予定を見るとずれる問題が発生する
    - これにより異なる日付に登録してしまう現象が起きる？
    - 別で考える
- 解決策

## カレンダーの月が重複して表示される

- 再現手順
  - ~~iphone 8で再現するか~~
  - `時間によってうまくいかない？`
    - 時刻の計算が単純にaddDateしてるだけなので、4/30 -> 2/30 のようになった時に、2/30が3月と認識され重複して表示する現象が起きる気がする
    - これっぽい
- 解決策
  - orignai monthを月の1日に設定する

## たまに落ちる

- 以下が表示される
  - Swiftでnilオブジェクトを入れてしまっているのが原因っぽい
    - device calendarかな？
    - 日付を変えているせい？
      - これっぽい、正しい日付でアプリを使うようにしたら、落ちなくなった
***Terminating app due to uncaught exception 'NSInvalidArgumentException', reason: '*** -[__NSPlaceholderDictionary initWithObjects:forKeys:count:]: attempt to insert nil object from objects[0]'
