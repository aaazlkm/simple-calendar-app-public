# デザイン調整する #91

- todo
  - [x] テキスト
  - [x] イベントの色
  - [x] floating action buttonの色
  - [x] closeした後にaddが走る時がある
  - [x] history取得はisolateでやった方がいいかもしれない
  - [x] event list pagerでエラーになることがある
  - [x] 祝日の色調整
  - [x] 背景色調整

## history取得はisolateでやった方がいいかもしれない

- 以下が出て死ぬ
- 原因がよくわからない&現状で動いているので無視する
- FlutterError' is not a subtype of type 'Exception

## closeした後にaddが走る時がある

- 原因
  - 祝日取得が遅いため、awaitしてる間にViewModelが閉じてしまうとエラーになる
  - これって祝日取得だけじゃなくて、他のものでも取得に時間がかかる場合エラーになるってことだよな
    - 他のコードも気をつけないといけないし、これでエラーになるのであれば、そもそもViewModelの実装がうまくない気がする
- 解決策
  - ~~ 1 closeしたかチェックしてデータを通知する ~~
    - 全ての処理にこれを書かないといけなくなる冗長だし、つけ忘れなどの問題が生じる
    - setStateをする時にmoutedで確認するような処理だね
      - 結局どこかでこのような処理は必要になるのか..
  - ~~ 2 closeして後に通知してもエラーにならないようにする~~
    - 勝手に無視してくれるようにする
    - エラーが消えてしまうのが微妙だよな
    - drainがやってくれるらしい
      - そういうわけではなさそう
        - データを捨てる駄絵kで、doneとエラーは通知されるらしい
    - これを実現するようなメソッドがそもそも存在しない感じがする
  - 3 ~~disposeが呼ばれたらfutureを中断するようにする~~
    - compositeSubscriptionみたいな感じで
    - CancelableOperationでfutureをキャンセルすることができそう？
      - <https://stackoverflow.com/a/54905898>
      - <https://qiita.com/kabochapo/items/c5061240f90468d16527>
    - できそう
      - usecaseで全部cancelOperationを返すようにして、それらを統合するcompositeを作成すればいけそう
      - con
        - ただ、値の取得の方法がダサい感じなる
        - streamみたいに綺麗に記述することができない
          - addComsiteがくっつた後に値を取得しないといけないため
            - 記述がよくわからないことになってしまう
        - あまりにも独自実装をしないといけなくなってしまう
  - 4 ~~ futureを使用せずにstreamだけを使用するようにする ~~
    - コードが醜くなるのが問題
      - どんどんネストが深くなってしまって可読性が落ちてしまう
  - 5 addIfnotClosedみたいな拡張関数を使用する
    - 中でcloseしてるかどうかをチェックする
    - 1よりはこちらの解決策の方がいい感じがする
  - 6 他のアーキテクチャんを使用する
    - ここら辺の考慮が必要ないアーキテクチャ探す
- 結論
  - 5しかなさそう
    - 6はまだ見つかっていないので、ここら辺の問題を解決するようなものを探す、考える
